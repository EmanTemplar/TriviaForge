<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trivia Presenter</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <nav class="navbar">
    <div class="logo">Trivia Presenter</div>
    <div class="room-code" id="liveRoomCode"></div>
    <div class="hamburger" id="hamburger">&#9776;</div>
    <ul class="menu" id="menu">
      <li><a href="index.html">Admin</a></li>
      <li><a href="player.html">Player</a></li>
      <li><a href="presenter.html">Presenter</a></li>
      <li><a href="display.html">Spectate</a></li>
      <li style="color: #4fc3f7; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 0.5rem; margin-top: 0.5rem;">
        <span id="presenterUsername">Admin</span>
      </li>
      <li>
        <a href="#" id="logoutBtn" style="color: #f66;">Logout</a>
      </li>
    </ul>
  </nav>

  <div class="presenter-container">
    <!-- Left Column: Create Room + Resume Session + Active Rooms -->
    <section class="presenter-sidebar">
      <div class="presenter-widget">
        <h2>Create Room</h2>
        <select id="quizSelector">
          <option value="">Select a quiz</option>
        </select>
        <button id="makeLiveBtn">Make Live</button>
        <button id="showQRBtn">Show Player QR Code</button>
      </div>

      <div class="presenter-widget">
        <h2>Resume Session</h2>
        <select id="incompleteSessionSelector">
          <option value="">No incomplete sessions</option>
        </select>
        <button id="resumeSessionBtn">Resume</button>
      </div>

      <div class="presenter-widget flex-grow">
        <h2>Active Rooms</h2>
        <div id="activeRooms"></div>
      </div>
    </section>

    <!-- Middle Column: Quiz Display -->
    <section id="quizDisplay">
      <h2 id="quizTitle">No Quiz Loaded</h2>
      <div id="questionsSection">
        <div id="questionsList"></div>
        <div class="presenter-controls">
          <div class="presenter-controls-row">
            <button id="prevBtn">‚Üê Previous</button>
            <button id="nextBtn">Next ‚Üí</button>
            <button id="presentBtn">Present Question to Players</button>
            <button id="revealBtn">Reveal Answer</button>
          </div>
          <button id="completeQuizBtn">Complete Quiz & Save Results</button>
        </div>
      </div>
    </section>

    <!-- Right Column: Connected Players -->
    <section class="presenter-players">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 style="margin: 0;">Connected Players</h2>
        <button id="presenterProgressBtn" style="
          display: none;
          padding: 0.5rem 1rem;
          background: rgba(79, 195, 247, 0.2);
          border: 1px solid rgba(79, 195, 247, 0.4);
          border-radius: 8px;
          color: #4fc3f7;
          cursor: pointer;
          font-size: 0.85rem;
          font-weight: 600;
          transition: all 0.2s;
          white-space: nowrap;
        "
        onmouseover="this.style.background='rgba(79, 195, 247, 0.3)'"
        onmouseout="this.style.background='rgba(79, 195, 247, 0.2)'"
        title="View live standings for all players">üìä Standings</button>
      </div>
      <div id="playerList" class="live-feed"></div>
    </section>
  </div>

  <!-- QR Code Modal -->
  <div id="qrModal">
    <div class="qr-modal-content">
      <h2>Scan to Join</h2>
      <img id="qrImage" src="" alt="QR Code" />
      <p id="qrUrl"></p>
      <button id="closeQRBtn">Close</button>
    </div>
  </div>

  <!-- Presenter Progress Modal (Live Standings) -->
  <div id="presenterProgressModal" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 2001; overflow-y: auto;">
    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 2rem; border-radius: 15px; max-width: 1000px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);">

      <!-- Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3 style="margin: 0; color: #fff; font-size: 1.5rem;">üìä Live Standings</h3>
        <button id="closePresenterProgressModal" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold;">‚úï Close</button>
      </div>

      <!-- Overall Stats Summary -->
      <div id="overallStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
        <!-- Stats cards will be populated here -->
      </div>

      <!-- Standings Table -->
      <div>
        <h4 style="color: #aaa; font-size: 1.1rem; margin: 0 0 1rem 0; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 0.5rem;">Player Standings</h4>
        <div id="standingsTable" style="background: rgba(0,0,0,0.3); border-radius: 8px; overflow: auto;">
          <!-- Standings table will be populated here -->
        </div>
      </div>

      <!-- Empty state -->
      <div id="presenterProgressEmptyState" style="text-align: center; padding: 3rem 1rem; color: #aaa;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üìù</div>
        <p style="font-size: 1.1rem; margin: 0;">No players have answered yet!</p>
        <p style="font-size: 0.9rem; margin: 0.5rem 0 0 0;">Standings will appear here once you present questions and players start answering.</p>
      </div>
    </div>
  </div>

  <!-- Custom Dialog Modal (for alerts and confirms) -->
  <div id="customDialog" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 2000;">
    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 2rem; border-radius: 15px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);">
      <div style="margin-bottom: 1.5rem;">
        <h3 id="dialogTitle" style="margin: 0 0 1rem 0; color: #fff; font-size: 1.3rem; text-align: center;"></h3>
        <p id="dialogMessage" style="margin: 0; color: #aaa; font-size: 1rem; line-height: 1.5; text-align: center;"></p>
      </div>
      <div id="dialogButtons" style="display: flex; gap: 1rem; justify-content: center;"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
<script>
  // --------------------
  // Authentication Check
  // --------------------
  (async () => {
    const token = localStorage.getItem('triviaAuthToken');

    if (!token) {
      window.location.href = 'landing.html';
      return;
    }

    // Verify token and check admin role
    try {
      const response = await fetch('/api/auth/me', {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!response.ok) {
        localStorage.removeItem('triviaAuthToken');
        window.location.href = 'landing.html';
        return;
      }

      const data = await response.json();

      if (data.user.account_type !== 'admin') {
        alert('Admin access required');
        localStorage.removeItem('triviaAuthToken');
        window.location.href = 'landing.html';
        return;
      }

      // Set username in navbar
      const usernameDisplay = document.getElementById('presenterUsername');
      if (usernameDisplay) {
        usernameDisplay.textContent = data.user.username;
      }
    } catch (err) {
      console.error('Authentication error:', err);
      localStorage.removeItem('triviaAuthToken');
      window.location.href = 'landing.html';
      return;
    }
  })();

  const socket = io();
  const quizSelector = document.getElementById('quizSelector');
  const makeLiveBtn = document.getElementById('makeLiveBtn');
  const incompleteSessionSelector = document.getElementById('incompleteSessionSelector');
  const resumeSessionBtn = document.getElementById('resumeSessionBtn');
  const quizTitleEl = document.getElementById('quizTitle');
  const questionsListEl = document.getElementById('questionsList');
  const playerListEl = document.getElementById('playerList');
  const activeRoomsEl = document.getElementById('activeRooms');
  const liveRoomCodeDiv = document.getElementById('liveRoomCode');
  const presentBtn = document.getElementById('presentBtn');
  const revealBtn = document.getElementById('revealBtn');
  const nextBtn = document.getElementById('nextBtn');
  const prevBtn = document.getElementById('prevBtn');
  const completeQuizBtn = document.getElementById('completeQuizBtn');
  const showQRBtn = document.getElementById('showQRBtn');
  const qrModal = document.getElementById('qrModal');
  const qrImage = document.getElementById('qrImage');
  const qrUrl = document.getElementById('qrUrl');
  const closeQRBtn = document.getElementById('closeQRBtn');

  let currentRoomCode = null;
  let currentQuestionIndex = -1;
  let currentQuestions = [];
  let presentedQuestionIndex = null;
  let presentedQuestions = []; // Track all questions that have been presented
  let revealedQuestions = []; // Track all questions that have had answers revealed
  let incompleteSessions = [];

  // Hamburger nav
  const menu = document.getElementById('menu');
  const hamburger = document.getElementById('hamburger');

  // Toggle menu on click (works on both mobile and desktop)
  hamburger.addEventListener('click', (e) => {
    e.stopPropagation(); // Prevent document listener from immediately closing
    menu.classList.toggle('open');
  });

  // Close menu when clicking/touching outside
  const closeMenuIfOutside = (e) => {
    if (menu.classList.contains('open') && !menu.contains(e.target) && e.target !== hamburger) {
      menu.classList.remove('open');
    }
  };

  document.addEventListener('click', closeMenuIfOutside);
  document.addEventListener('touchstart', closeMenuIfOutside);

  // --------------------
  // Custom Dialog Functions
  // --------------------
  const customAlert = (message, title = 'Notification') => {
    return new Promise((resolve) => {
      const dialog = document.getElementById('customDialog');
      const dialogTitle = document.getElementById('dialogTitle');
      const dialogMessage = document.getElementById('dialogMessage');
      const dialogButtons = document.getElementById('dialogButtons');

      dialogTitle.textContent = title;
      dialogMessage.textContent = message;

      dialogButtons.innerHTML = '';
      const okBtn = document.createElement('button');
      okBtn.textContent = 'OK';
      okBtn.style.cssText = 'padding: 0.75rem 2rem; background: rgba(0,123,255,0.3); border: 1px solid rgba(0,123,255,0.5); color: #fff; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.2s;';
      okBtn.onmouseover = () => okBtn.style.background = 'rgba(0,123,255,0.5)';
      okBtn.onmouseout = () => okBtn.style.background = 'rgba(0,123,255,0.3)';
      okBtn.onclick = () => {
        dialog.style.display = 'none';
        resolve();
      };
      dialogButtons.appendChild(okBtn);

      dialog.style.display = 'flex';
      okBtn.focus();
    });
  };

  const customConfirm = (message, title = 'Confirm Action') => {
    return new Promise((resolve) => {
      const dialog = document.getElementById('customDialog');
      const dialogTitle = document.getElementById('dialogTitle');
      const dialogMessage = document.getElementById('dialogMessage');
      const dialogButtons = document.getElementById('dialogButtons');

      dialogTitle.textContent = title;
      dialogMessage.textContent = message;

      dialogButtons.innerHTML = '';

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.style.cssText = 'padding: 0.75rem 2rem; background: rgba(100,100,100,0.3); border: 1px solid rgba(100,100,100,0.5); color: #fff; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: all 0.2s;';
      cancelBtn.onmouseover = () => cancelBtn.style.background = 'rgba(100,100,100,0.5)';
      cancelBtn.onmouseout = () => cancelBtn.style.background = 'rgba(100,100,100,0.3)';
      cancelBtn.onclick = () => {
        dialog.style.display = 'none';
        resolve(false);
      };

      const confirmBtn = document.createElement('button');
      confirmBtn.textContent = 'Confirm';
      confirmBtn.style.cssText = 'padding: 0.75rem 2rem; background: rgba(0,200,0,0.3); border: 1px solid rgba(0,200,0,0.5); color: #fff; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.2s;';
      confirmBtn.onmouseover = () => confirmBtn.style.background = 'rgba(0,200,0,0.5)';
      confirmBtn.onmouseout = () => confirmBtn.style.background = 'rgba(0,200,0,0.3)';
      confirmBtn.onclick = () => {
        dialog.style.display = 'none';
        resolve(true);
      };

      dialogButtons.appendChild(cancelBtn);
      dialogButtons.appendChild(confirmBtn);

      dialog.style.display = 'flex';
      confirmBtn.focus();
    });
  };

  // Enhanced Answer Reveal Modal
  const showAnswerRevealModal = (question, results) => {
    return new Promise((resolve) => {
      const dialog = document.getElementById('customDialog');
      const dialogTitle = document.getElementById('dialogTitle');
      const dialogMessage = document.getElementById('dialogMessage');
      const dialogButtons = document.getElementById('dialogButtons');

      dialogTitle.textContent = 'Answer Revealed!';

      // Calculate statistics
      const totalPlayers = results.length;
      const correctCount = results.filter(r => r.is_correct).length;
      const answeredCount = results.filter(r => r.choice !== null).length;
      const correctPercentage = answeredCount > 0 ? Math.round((correctCount / answeredCount) * 100) : 0;

      // Build HTML content with table
      const messageHTML = `
        <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(0,200,0,0.2); border-radius: 8px; border: 1px solid rgba(0,200,0,0.5);">
          <div style="font-weight: bold; margin-bottom: 0.5rem;">Correct Answer:</div>
          <div style="font-size: 1.1rem; color: #0f0;">${question.choices[question.correctChoice]}</div>
        </div>

        <div style="margin-bottom: 1rem; display: flex; gap: 1rem; justify-content: space-around; font-size: 0.9rem;">
          <div><strong>${correctCount}/${answeredCount}</strong> correct</div>
          <div><strong>${correctPercentage}%</strong> accuracy</div>
          <div><strong>${totalPlayers - answeredCount}</strong> no answer</div>
        </div>

        <div style="margin-top: 1.5rem;">
          <div style="font-weight: bold; margin-bottom: 0.75rem; color: #fff;">Player Responses:</div>
          <div style="max-height: 400px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 0.5rem;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="border-bottom: 2px solid rgba(255,255,255,0.2);">
                  <th style="text-align: left; padding: 0.75rem 0.5rem; color: #aaa; font-weight: bold;">Player</th>
                  <th style="text-align: left; padding: 0.75rem 0.5rem; color: #aaa; font-weight: bold;">Answer</th>
                  <th style="text-align: center; padding: 0.75rem 0.5rem; color: #aaa; font-weight: bold; width: 60px;">Result</th>
                </tr>
              </thead>
              <tbody>
                ${results.map(r => {
                  const answerText = r.choice !== null ? question.choices[r.choice] : 'No answer';
                  const resultIcon = r.is_correct ? '‚úì' : (r.choice !== null ? '‚úó' : '‚Äî');
                  const resultColor = r.is_correct ? '#0f0' : (r.choice !== null ? '#f66' : '#aaa');
                  const bgColor = r.is_correct ? 'rgba(0,200,0,0.1)' : (r.choice !== null ? 'rgba(200,0,0,0.1)' : 'rgba(100,100,100,0.1)');

                  return `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); background: ${bgColor};">
                      <td style="padding: 0.75rem 0.5rem; font-weight: bold;">${r.name}</td>
                      <td style="padding: 0.75rem 0.5rem; color: ${r.choice !== null ? '#fff' : '#aaa'};">${answerText}</td>
                      <td style="padding: 0.75rem 0.5rem; text-align: center; font-size: 1.2rem; font-weight: bold; color: ${resultColor};">${resultIcon}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;

      dialogMessage.innerHTML = messageHTML;
      dialogMessage.style.textAlign = 'left';

      dialogButtons.innerHTML = '';
      const okBtn = document.createElement('button');
      okBtn.textContent = 'Close';
      okBtn.style.cssText = 'padding: 0.75rem 2rem; background: rgba(0,123,255,0.3); border: 1px solid rgba(0,123,255,0.5); color: #fff; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.2s;';
      okBtn.onmouseover = () => okBtn.style.background = 'rgba(0,123,255,0.5)';
      okBtn.onmouseout = () => okBtn.style.background = 'rgba(0,123,255,0.3)';
      okBtn.onclick = () => {
        dialog.style.display = 'none';
        dialogMessage.style.textAlign = 'center'; // Reset to default
        resolve();
      };
      dialogButtons.appendChild(okBtn);

      dialog.style.display = 'flex';
      okBtn.focus();
    });
  };

  // Load quiz list
  async function loadQuizzes() {
    try {
      const token = localStorage.getItem('triviaAuthToken');
      const res = await fetch('/api/quizzes', {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!res.ok) {
        console.error('Failed to load quizzes:', res.status);
        return;
      }

      const quizzes = await res.json();
      quizSelector.innerHTML = '<option value="">Select a quiz</option>';
      quizzes.forEach(q => {
        const opt = document.createElement('option');
        opt.value = q.filename;
        opt.textContent = q.title;
        quizSelector.appendChild(opt);
      });
    } catch (err) {
      console.error('Error loading quizzes:', err);
    }
  }
  loadQuizzes();

  // Load incomplete sessions
  async function loadIncompleteSessions() {
    try {
      const token = localStorage.getItem('triviaAuthToken');
      const res = await fetch('/api/sessions/incomplete', {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!res.ok) {
        console.error('Failed to load incomplete sessions:', res.status);
        return;
      }

      incompleteSessions = await res.json();

      if (incompleteSessions.length === 0) {
        incompleteSessionSelector.innerHTML = '<option value="">No incomplete sessions</option>';
        resumeSessionBtn.disabled = true;
        resumeSessionBtn.style.opacity = '0.5';
      } else {
        incompleteSessionSelector.innerHTML = '<option value="">Select session to resume</option>';
        incompleteSessions.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.filename;
          const displayDate = s.resumedAt ? new Date(s.resumedAt).toLocaleString() : new Date(s.createdAt).toLocaleString();
          const dateLabel = s.resumedAt ? 'Resumed' : 'Started';
          const resumedIcon = s.resumedAt ? '‚Üª ' : '';
          const status = s.status === 'interrupted' ? '‚ö†Ô∏è Interrupted' : '‚è∏Ô∏è In Progress';
          opt.textContent = `${resumedIcon}${s.quizTitle} (${s.roomCode}) - ${status} - ${dateLabel}: ${displayDate}`;
          incompleteSessionSelector.appendChild(opt);
        });
        resumeSessionBtn.disabled = false;
        resumeSessionBtn.style.opacity = '1';
      }
    } catch (err) {
      console.error('Error loading incomplete sessions:', err);
    }
  }
  loadIncompleteSessions();

  // Resume session button
  resumeSessionBtn.addEventListener('click', async () => {
    const sessionFilename = incompleteSessionSelector.value;
    if (!sessionFilename) {
      await customAlert('Select a session to resume', 'No Session Selected');
      return;
    }

    const session = incompleteSessions.find(s => s.filename === sessionFilename);
    const confirmed = await customConfirm(`Resume session for "${session.quizTitle}" (original room: ${session.roomCode})?\n\nPlayers will need to rejoin with their original names to keep their progress.`, 'Resume Session');
    if (confirmed) {
      socket.emit('resumeSession', { sessionFilename });
    }
  });

// --------------------
// Live Rooms Logic
// --------------------

// Make new room
makeLiveBtn.addEventListener('click', async () => {
  const quizFilename = quizSelector.value;
  if (!quizFilename) {
    await customAlert('Select a quiz first', 'No Quiz Selected');
    return;
  }
  const roomCode = Math.floor(1000 + Math.random() * 9000).toString();
  socket.emit('createRoom', { roomCode, quizFilename });
});

// Render questions with proper data structure
function renderQuestions() {
  if (!currentQuestions.length) {
    questionsListEl.innerHTML = '<em>No questions in this quiz</em>';
    return;
  }

  questionsListEl.innerHTML = currentQuestions.map((q, i) => {
    const isSelected = i === currentQuestionIndex;
    const isLive = i === presentedQuestionIndex;
    const wasPresented = presentedQuestions.includes(i) && !isLive;
    const wasRevealed = revealedQuestions.includes(i);

    let statusBadge = '';
    if (isLive) {
      statusBadge = '<span style="color:#ff0; font-weight:bold; font-size:0.9rem; margin-left:0.5rem;">‚óè LIVE</span>';
    } else if (wasPresented) {
      statusBadge = '<span style="color:#0f0; font-weight:bold; font-size:0.9rem; margin-left:0.5rem;">‚úì Presented</span>';
    }

    if (wasRevealed) {
      statusBadge += '<span style="color:#f00; font-weight:bold; font-size:0.9rem; margin-left:0.5rem;">‚úì Revealed</span>';
    }

    return `
      <div class="questionCard ${isSelected ? 'presented' : ''}" onclick="selectQuestion(${i})" style="cursor:pointer;">
        <strong>Q${i+1}:</strong> ${q.text} ${statusBadge}
        <ul>
          ${q.choices.map((choice, idx) => `
            <li${q.correctChoice === idx ? ' style="color:#0f0"' : ''}>${choice}</li>
          `).join('')}
        </ul>
      </div>
    `;
  }).join('');
}

// Select a question by clicking on it
window.selectQuestion = (index) => {
  currentQuestionIndex = index;
  renderQuestions();
};

// Update active rooms list and highlight current
function renderActiveRooms(rooms) {
  if (!rooms.length) {
    activeRoomsEl.innerHTML = '<em>No active rooms</em>';
    return;
  }

  activeRoomsEl.innerHTML = rooms.map(r => `
    <div class="roomCard ${r.roomCode === currentRoomCode ? 'activeRoom' : ''}" onclick="viewRoom('${r.roomCode}')">
      <div><strong>${r.quizTitle}</strong> (${r.roomCode})</div>
      <div>${r.playerCount} player(s)</div>
      <button onclick="event.stopPropagation(); closeRoom('${r.roomCode}')">Close</button>
    </div>
  `).join('');
}

// View room
window.viewRoom = (roomCode) => {
  currentRoomCode = roomCode;
  liveRoomCodeDiv.textContent = `Room: ${roomCode}`;
  socket.emit('viewRoom', { roomCode });
  renderActiveRooms(window.cachedRooms || []);
};

// Room created (includes resumed sessions)
socket.on('roomCreated', ({ roomCode, quizTitle, questions, presentedQuestions: serverPresentedQuestions, revealedQuestions: serverRevealedQuestions, isResumed, originalRoomCode }) => {
  currentRoomCode = roomCode;
  currentQuestions = questions || [];
  currentQuestionIndex = 0;
  presentedQuestionIndex = null;
  presentedQuestions = serverPresentedQuestions || [];
  revealedQuestions = serverRevealedQuestions || [];
  liveRoomCodeDiv.textContent = `Room: ${roomCode}`;
  quizTitleEl.textContent = quizTitle;
  renderQuestions();

  // Show progress button for newly created room
  presenterProgressBtn.style.display = 'inline-block';

  if (isResumed) {
    customAlert(`Session resumed!\n\nNew room code: ${roomCode}\nOriginal room: ${originalRoomCode}\n\nPlayers should rejoin with their original names.`, 'Session Resumed');
  }
});

// Room restored from server (when viewing a room)
socket.on('roomRestored', ({ roomCode, quizTitle, questions, players }) => {
  if (roomCode !== currentRoomCode) return;

  currentQuestions = questions || [];
  currentQuestionIndex = 0;
  presentedQuestionIndex = null;
  quizTitleEl.textContent = quizTitle;
  renderQuestions();
  
  playerListEl.innerHTML = players.length
    ? players.map(p => `<div><span style="color: ${p.connected ? '#0f0' : '#f00'}">‚óè</span> ${p.name}</div>`).join('')
    : '<em>No players yet</em>';
});

// Player list updates (scoped to current room)
socket.on('playerListUpdate', ({ roomCode, players }) => {
  if (roomCode !== currentRoomCode) return;
  playerListEl.innerHTML = players.length
    ? players.map(p => `<div><span style="color: ${p.connected ? '#0f0' : '#f00'}">‚óè</span> ${p.name}${p.choice !== null ? ' ‚úì' : ''}</div>`).join('')
    : '<em>No players yet</em>';
});

// Active rooms update
socket.on('activeRoomsUpdate', (rooms) => {
  window.cachedRooms = rooms;
  renderActiveRooms(rooms);
});

// Close room
window.closeRoom = async (roomCode) => {
  const confirmed = await customConfirm(`Close room ${roomCode}?`, 'Close Room');
  if (confirmed) {
    socket.emit('closeRoom', { roomCode });
    if (currentRoomCode === roomCode) {
      currentRoomCode = null;
      currentQuestions = [];
      currentQuestionIndex = -1;
      liveRoomCodeDiv.textContent = '';
      quizTitleEl.textContent = 'No Quiz Loaded';
      questionsListEl.innerHTML = '';
      playerListEl.innerHTML = '';
    }
  }
};

socket.on('roomClosed', ({ roomCode }) => {
  if (currentRoomCode === roomCode) {
    customAlert('Room closed.', 'Room Closed');
    currentRoomCode = null;
    currentQuestions = [];
    currentQuestionIndex = -1;
    liveRoomCodeDiv.textContent = '';
    quizTitleEl.textContent = 'No Quiz Loaded';
    questionsListEl.innerHTML = '';
    playerListEl.innerHTML = '';
  }
});

// --------------------
// END OF ROOM LOGIC
// --------------------

// ---------------- Navigation and Control Buttons ----------------

// Previous button - just navigation
prevBtn.addEventListener('click', async () => {
  if (!currentRoomCode) {
    await customAlert('No room selected.', 'No Room');
    return;
  }
  if (!currentQuestions.length) {
    await customAlert('No questions loaded.', 'No Questions');
    return;
  }
  if (currentQuestionIndex <= 0) {
    await customAlert('Already at first question.', 'First Question');
    return;
  }
  currentQuestionIndex--;
  renderQuestions();
});

// Next button - just navigation
nextBtn.addEventListener('click', async () => {
  if (!currentRoomCode) {
    await customAlert('No room selected.', 'No Room');
    return;
  }
  if (!currentQuestions.length) {
    await customAlert('No questions loaded.', 'No Questions');
    return;
  }
  if (currentQuestionIndex >= currentQuestions.length - 1) {
    await customAlert('Already at last question.', 'Last Question');
    return;
  }
  currentQuestionIndex++;
  renderQuestions();
});

// Present Question button - sends question to players (only one at a time)
presentBtn.addEventListener('click', async () => {
  if (!currentRoomCode) {
    await customAlert('No room selected.', 'No Room');
    return;
  }
  if (currentQuestionIndex < 0) {
    await customAlert('No question selected.', 'No Question');
    return;
  }
  if (!currentQuestions.length) {
    await customAlert('No questions loaded.', 'No Questions');
    return;
  }

  presentedQuestionIndex = currentQuestionIndex;
  renderQuestions();
  socket.emit('presentQuestion', { roomCode: currentRoomCode, questionIndex: currentQuestionIndex });
});

// Reveal Answer button - shows correct answer to players
revealBtn.addEventListener('click', async () => {
  if (!currentRoomCode) {
    await customAlert('No room selected.', 'No Room');
    return;
  }
  if (presentedQuestionIndex === null) {
    await customAlert('Please present a question to players first.', 'No Question Presented');
    return;
  }

  socket.emit('revealAnswer', { roomCode: currentRoomCode });
});

// Complete Quiz button - marks quiz as complete and saves results
completeQuizBtn.addEventListener('click', async () => {
  if (!currentRoomCode) {
    await customAlert('No room selected.', 'No Room');
    return;
  }
  const confirmed = await customConfirm('Complete this quiz and save all results? This will mark the session as finished.', 'Complete Quiz');
  if (confirmed) {
    socket.emit('completeQuiz', { roomCode: currentRoomCode });
  }
});

// Show QR code for player page
showQRBtn.addEventListener('click', async () => {
  try {
    let url = '/api/qr/player';
    if (currentRoomCode) {
      url = `/api/qr/room/${currentRoomCode}`;
    }
    
    const res = await fetch(url);
    const data = await res.json();
    
    qrImage.src = data.qrCode;
    qrUrl.textContent = data.url;
    qrModal.style.display = 'flex';
  } catch (err) {
    await customAlert('Failed to generate QR code', 'QR Code Error');
    console.error(err);
  }
});

closeQRBtn.addEventListener('click', () => {
  qrModal.style.display = 'none';
});

qrModal.addEventListener('click', (e) => {
  if (e.target === qrModal) {
    qrModal.style.display = 'none';
  }
});

// Question presented confirmation
socket.on('questionPresented', ({ questionIndex, question, presentedQuestions: serverPresentedQuestions }) => {
  console.log('Question presented:', question.text);
  if (serverPresentedQuestions) {
    presentedQuestions = serverPresentedQuestions;
  }
  renderQuestions();
  playerListEl.innerHTML = playerListEl.innerHTML.replace(/‚úì/g, '');
});

// Question revealed confirmation
socket.on('questionRevealed', ({ questionIndex, question, results, revealedQuestions: serverRevealedQuestions }) => {
  if (serverRevealedQuestions) {
    revealedQuestions = serverRevealedQuestions;
  }
  renderQuestions();

  // Show enhanced answer reveal modal with formatted table
  showAnswerRevealModal(question, results);
});

// Quiz completed confirmation
socket.on('quizCompleted', ({ message, filename }) => {
  customAlert(message, 'Quiz Completed');
  if (filename) {
    console.log('Session saved as:', filename);
  }
  // Reload incomplete sessions list to remove completed ones
  loadIncompleteSessions();
});

// Request initial active rooms on load
socket.emit('getActiveRooms');

// ---------------------------
// Presenter Progress Modal Functions
// ---------------------------
const presenterProgressBtn = document.getElementById('presenterProgressBtn');
const presenterProgressModal = document.getElementById('presenterProgressModal');
const closePresenterProgressModal = document.getElementById('closePresenterProgressModal');
const overallStats = document.getElementById('overallStats');
const standingsTable = document.getElementById('standingsTable');
const presenterProgressEmptyState = document.getElementById('presenterProgressEmptyState');

async function showPresenterProgressModal() {
  presenterProgressModal.style.display = 'flex';
  await fetchAndDisplayPresenterProgress();
}

function hidePresenterProgressModal() {
  presenterProgressModal.style.display = 'none';
}

async function fetchAndDisplayPresenterProgress() {
  if (!currentRoomCode) {
    presenterProgressEmptyState.style.display = 'block';
    overallStats.style.display = 'none';
    standingsTable.style.display = 'none';
    return;
  }

  try {
    // Show loading state
    overallStats.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #aaa;">Loading standings...</div>';
    standingsTable.innerHTML = '';

    // Fetch all players' progress from backend
    const response = await fetch(`/api/room/progress/${currentRoomCode}`);

    if (!response.ok) {
      throw new Error('Failed to fetch room progress');
    }

    const roomProgress = await response.json();

    // Check if there's any data to display
    if (!roomProgress.players || roomProgress.players.length === 0 || !roomProgress.players.some(p => p.answered > 0)) {
      presenterProgressEmptyState.style.display = 'block';
      overallStats.style.display = 'none';
      standingsTable.style.display = 'none';
      return;
    } else {
      presenterProgressEmptyState.style.display = 'none';
      overallStats.style.display = 'grid';
      standingsTable.style.display = 'block';
    }

    // Sort players by correct count (descending), then by accuracy
    const sortedPlayers = [...roomProgress.players].sort((a, b) => {
      if (b.correct !== a.correct) return b.correct - a.correct;
      if (a.answered === 0 && b.answered === 0) return 0;
      const accuracyA = a.answered > 0 ? (a.correct / a.answered) : 0;
      const accuracyB = b.answered > 0 ? (b.correct / b.answered) : 0;
      return accuracyB - accuracyA;
    });

    // Calculate overall stats
    const totalPlayers = sortedPlayers.length;
    const totalAnswered = sortedPlayers.reduce((sum, p) => sum + p.answered, 0);
    const totalCorrect = sortedPlayers.reduce((sum, p) => sum + p.correct, 0);
    const totalIncorrect = sortedPlayers.reduce((sum, p) => sum + (p.answered - p.correct), 0);
    const overallAccuracy = totalAnswered > 0 ? ((totalCorrect / totalAnswered) * 100).toFixed(1) : '0.0';
    const avgCorrect = totalPlayers > 0 ? (totalCorrect / totalPlayers).toFixed(1) : '0.0';

    // Render overall stats
    overallStats.innerHTML = `
      <div style="background: rgba(0,200,0,0.2); border: 1px solid rgba(0,200,0,0.3); border-radius: 10px; padding: 1rem; text-align: center;">
        <div style="font-size: 2rem; font-weight: bold; color: #0f0;">${totalPlayers}</div>
        <div style="font-size: 0.9rem; color: #aaa;">Players</div>
      </div>
      <div style="background: rgba(0,200,0,0.2); border: 1px solid rgba(0,200,0,0.3); border-radius: 10px; padding: 1rem; text-align: center;">
        <div style="font-size: 2rem; font-weight: bold; color: #0f0;">${totalCorrect}</div>
        <div style="font-size: 0.9rem; color: #aaa;">Total Correct</div>
      </div>
      <div style="background: rgba(200,0,0,0.2); border: 1px solid rgba(200,0,0,0.3); border-radius: 10px; padding: 1rem; text-align: center;">
        <div style="font-size: 2rem; font-weight: bold; color: #f66;">${totalIncorrect}</div>
        <div style="font-size: 0.9rem; color: #aaa;">Total Incorrect</div>
      </div>
      <div style="background: rgba(79,195,247,0.2); border: 1px solid rgba(79,195,247,0.3); border-radius: 10px; padding: 1rem; text-align: center;">
        <div style="font-size: 2rem; font-weight: bold; color: #4fc3f7;">${overallAccuracy}%</div>
        <div style="font-size: 0.9rem; color: #aaa;">Class Accuracy</div>
      </div>
      <div style="background: rgba(255,165,0,0.2); border: 1px solid rgba(255,165,0,0.3); border-radius: 10px; padding: 1rem; text-align: center;">
        <div style="font-size: 2rem; font-weight: bold; color: #ffa500;">${avgCorrect}</div>
        <div style="font-size: 0.9rem; color: #aaa;">Avg per Player</div>
      </div>
    `;

    // Render standings table
    standingsTable.innerHTML = `
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="border-bottom: 2px solid rgba(255,255,255,0.2);">
            <th style="text-align: center; padding: 1rem 0.5rem; color: #aaa; font-weight: bold; width: 40px;">#</th>
            <th style="text-align: left; padding: 1rem 0.5rem; color: #aaa; font-weight: bold;">Player</th>
            <th style="text-align: center; padding: 1rem 0.5rem; color: #aaa; font-weight: bold;">Correct</th>
            <th style="text-align: center; padding: 1rem 0.5rem; color: #aaa; font-weight: bold;">Incorrect</th>
            <th style="text-align: center; padding: 1rem 0.5rem; color: #aaa; font-weight: bold;">Accuracy</th>
            <th style="text-align: center; padding: 1rem 0.5rem; color: #aaa; font-weight: bold;">Answered</th>
          </tr>
        </thead>
        <tbody>
          ${sortedPlayers.map((player, idx) => {
            const accuracy = player.answered > 0 ? ((player.correct / player.answered) * 100).toFixed(1) : '-';
            const bgColor = idx === 0 ? 'rgba(255,215,0,0.15)' : (idx === 1 ? 'rgba(192,192,192,0.15)' : (idx === 2 ? 'rgba(205,127,50,0.15)' : 'rgba(100,100,100,0.05)'));
            const medal = idx === 0 ? 'ü•á' : (idx === 1 ? 'ü•à' : (idx === 2 ? 'ü•â' : ''));

            return `
              <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); background: ${bgColor};">
                <td style="text-align: center; padding: 1rem 0.5rem; font-weight: bold; color: #aaa;">${medal ? medal : idx + 1}</td>
                <td style="padding: 1rem 0.5rem; font-weight: bold; color: #fff;">${player.name}</td>
                <td style="text-align: center; padding: 1rem 0.5rem; color: #0f0; font-weight: bold;">${player.correct}</td>
                <td style="text-align: center; padding: 1rem 0.5rem; color: #f66; font-weight: bold;">${player.answered - player.correct}</td>
                <td style="text-align: center; padding: 1rem 0.5rem; color: #4fc3f7; font-weight: bold;">${accuracy}%</td>
                <td style="text-align: center; padding: 1rem 0.5rem; color: #ffa500; font-weight: bold;">${player.answered}</td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    `;

  } catch (err) {
    console.error('Error fetching presenter progress:', err);
    presenterProgressEmptyState.style.display = 'block';
    overallStats.style.display = 'none';
    standingsTable.style.display = 'none';
  }
}

// Event listeners for presenter progress modal
presenterProgressBtn.addEventListener('click', showPresenterProgressModal);
closePresenterProgressModal.addEventListener('click', hidePresenterProgressModal);

// Close modal when clicking outside
presenterProgressModal.addEventListener('click', (e) => {
  if (e.target === presenterProgressModal) {
    hidePresenterProgressModal();
  }
});

// Show/hide progress button based on room state
const originalViewRoom = window.viewRoom;
window.viewRoom = (roomCode) => {
  originalViewRoom(roomCode);
  presenterProgressBtn.style.display = 'inline-block';
};

// Hide progress button when room is closed
socket.on('roomClosed', ({ roomCode }) => {
  if (currentRoomCode === roomCode) {
    presenterProgressBtn.style.display = 'none';
  }
});

// ---------------------------
// Logout Functionality
// ---------------------------
const logoutBtn = document.getElementById('logoutBtn');
if (logoutBtn) {
  logoutBtn.addEventListener('click', async (e) => {
    e.preventDefault();

    const token = localStorage.getItem('triviaAuthToken');
    if (token) {
      try {
        await fetch('/api/auth/logout', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });
      } catch (err) {
        console.error('Logout error:', err);
      }
    }

    localStorage.removeItem('triviaAuthToken');
    window.location.href = 'landing.html';
  });
}
</script>

</body>
</html>